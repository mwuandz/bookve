<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ƒê·∫∑t ch·ªó ng·ªìi (Firebase Realtime)</title>
  <style>
    :root {
      --seat-size: 44px;
      --gap: 8px;
      --bg: #0f172a;
      --text: #e5e7eb;
      --free: #f97316;
      --taken: #6b7280;
      --mine: #22c55e;
      --blocked: #111827;
      --screen: #e5e7eb;
      --badge: #0ea5e9;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display: grid; place-items: start center; min-height: 100svh; padding: 24px;
    }
    .app { width: min(980px, 96vw); }
    h1 { margin: 8px 0 16px; font-size: 22px; font-weight: 700; }
    .topbar {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 14px;
    }
    .input {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 12px; border-radius: 10px; background: #111827;
    }
    .input input {
      background: transparent; border: none; outline: none; color: var(--text);
      font-size: 14px; width: 220px;
    }
    button {
      border: none; background: var(--badge); color: white; padding: 10px 14px;
      border-radius: 10px; font-weight: 600; cursor: pointer;
    }
    button.secondary { background: #374151; }
    .legend { display:flex; gap:14px; align-items:center; font-size:13px; opacity:.9 }
    .dot { width:14px; height:14px; border-radius:4px; display:inline-block; margin-right:6px }
    .screen {
      text-align: center; padding: 10px; margin: 16px auto 12px;
      border-radius: 10px; color: #111827; background: var(--screen); width: 60%;
      font-weight: 700; letter-spacing: 0.5px;
    }
    .grid {
      display: grid;
      grid-template-columns: 28px repeat(11, var(--seat-size));
      gap: var(--gap);
      align-items: center;
      justify-content: center;
      margin-top: 8px;
    }
    .rowLabel {
      text-align: right; opacity: .8; font-weight: 700;
    }
    .seat {
      width: var(--seat-size); height: var(--seat-size);
      border-radius: 10px; background: var(--free);
      display: grid; place-items: center; font-weight: 700; cursor: pointer;
      position: relative; user-select: none; transition: transform .05s ease;
    }
    .seat:hover { transform: translateY(-2px); }
    .seat.taken { background: var(--taken); cursor: not-allowed; }
    .seat.mine  { background: var(--mine); }
    .seat.blocked { background: var(--blocked); cursor: default; }
    .seat small {
      position: absolute; bottom: 4px; font-size: 10px; font-weight: 600; opacity: .95;
    }
    .footer { margin-top: 18px; opacity: .75; font-size: 12px }
  </style>
</head>
<body>
  <div class="app">
    <h1>ƒê·∫∑t ch·ªó ng·ªìi</h1>
    <div class="topbar">
      <div class="input">
        <span>üë§ T√™n b·∫°n:</span>
        <input id="nameInput" placeholder="Nh·∫≠p t√™n ƒë·ªÉ gi·ªØ gh·∫ø‚Ä¶" />
      </div>
      <button id="releaseBtn" class="secondary" title="B·ªè gh·∫ø c·ªßa b·∫°n">B·ªè gh·∫ø</button>
      <div class="legend" aria-hidden="true">
        <span><span class="dot" style="background: var(--free)"></span>Tr·ªëng</span>
        <span><span class="dot" style="background: var(--taken)"></span>ƒê√£ gi·ªØ</span>
        <span><span class="dot" style="background: var(--mine)"></span>Gh·∫ø c·ªßa t√¥i</span>
        <span><span class="dot" style="background: var(--blocked)"></span>Kh√¥ng c√≥ gh·∫ø</span>
      </div>
    </div>

    <div class="screen">M√ÄN H√åNH</div>
    <div id="grid" class="grid" role="grid" aria-label="S∆° ƒë·ªì ch·ªó ng·ªìi"></div>
    <div class="footer">Realtime b·∫±ng Firebase. M·ªói ng∆∞·ªùi d√πng ch·ªâ gi·ªØ 1 gh·∫ø.</div>
  </div>

  <script type="module">
    // ============ Firebase config (ƒêI·ªÄN C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ============
    const firebaseConfig = {
  apiKey: "AIzaSyDSYH9yGzdtm3RjZuR7yjLhj4VH9qm-9PQ",
  authDomain: "xemphim-aed3c.firebaseapp.com",
  projectId: "xemphim-aed3c",
  storageBucket: "xemphim-aed3c.firebasestorage.app",
  messagingSenderId: "175453208138",
  appId: "1:175453208138:web:7436fe257eaafb2c6bf0b3",
  measurementId: "G-KJZY7SS6ES"
};

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, get, child, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // user id c·ª•c b·ªô theo tr√¨nh duy·ªát
    const USER_KEY = "seat_user_id_v1";
    const NAME_KEY = "seat_user_name_v1";
    const userId = localStorage.getItem(USER_KEY) || (() => {
      const id = crypto.getRandomValues(new Uint32Array(4)).join("-");
      localStorage.setItem(USER_KEY, id);
      return id;
    })();
    const nameInput = document.getElementById('nameInput');
    nameInput.value = localStorage.getItem(NAME_KEY) || "";
    nameInput.addEventListener('input', () => {
      localStorage.setItem(NAME_KEY, nameInput.value.trim());
    });

    const releaseBtn = document.getElementById('releaseBtn');

    // S∆° ƒë·ªì gh·∫ø
    const rows = "ABCDEFGHIJ".split("");
    const cols = Array.from({length: 11}, (_,i)=> i+1);
    const blockedSeats = new Set(["H10","H11","J6","J7"]);
    const grid = document.getElementById('grid');
    function seatId(r,c){ return `${r}${c}` }

    function renderGrid(){
      grid.innerHTML = "";
      for (const r of rows){
        const label = document.createElement('div');
        label.className = "rowLabel";
        label.textContent = r;
        grid.appendChild(label);

        for (const c of cols){
          const id = seatId(r,c);
          const el = document.createElement('div');
          el.role = "gridcell";
          el.className = "seat";
          el.dataset.id = id;

          if (blockedSeats.has(id)) {
            el.classList.add('blocked');
          } else {
            el.textContent = c;
            const nameTag = document.createElement('small');
            nameTag.className = "holder";
            el.appendChild(nameTag);
            el.addEventListener('click', () => tryClaim(id));
          }
          grid.appendChild(el);
        }
      }
    }
    renderGrid();

    // DB paths
    const ROOM = "default";
    const seatsRef = ref(db, `rooms/${ROOM}/seats`);
    const claimsRef = ref(db, `rooms/${ROOM}/claims`);

    let mySeat = null;

    onValue(seatsRef, (snap) => {
      const data = snap.val() || {};
      mySeat = null;
      document.querySelectorAll('.seat').forEach(el => {
        if (el.classList.contains('blocked')) return;
        const id = el.dataset.id;
        const s = data[id];
        el.classList.remove('taken','mine');
        const holder = el.querySelector('.holder');
        if (holder) holder.textContent = "";
        if (s && s.userId){
          if (s.userId === userId){
            el.classList.add('mine');
            mySeat = id;
          } else {
            el.classList.add('taken');
          }
          if (holder && s.name) holder.textContent = s.name;
        }
      });
      releaseBtn.disabled = !mySeat;
    });

    async function tryClaim(id){
      if (blockedSeats.has(id)) return;
      const name = nameInput.value.trim();
      if (!name){ alert("Nh·∫≠p t√™n tr∆∞·ªõc khi gi·ªØ gh·∫ø nh√©!"); return; }

      const myClaimSnap = await get(child(claimsRef, userId));
      const claimed = myClaimSnap.val();
      if (claimed && claimed !== id){
        alert(`B·∫°n ƒë√£ gi·ªØ gh·∫ø ${claimed}. B·∫•m 'B·ªè gh·∫ø' tr∆∞·ªõc khi ch·ªçn gh·∫ø kh√°c.`);
        return;
      }

      await runTransaction(child(seatsRef, id), (cur) => {
        if (cur && cur.userId && cur.userId !== userId){
          return cur; // ƒë√£ c√≥ ng∆∞·ªùi kh√°c gi·ªØ
        }
        return { userId, name, ts: Date.now() };
      });

      await set(child(claimsRef, userId), id);
    }

    releaseBtn.addEventListener('click', async () => {
      if (!mySeat) return;
      const seatPath = child(seatsRef, mySeat);
      await runTransaction(seatPath, (cur) => {
        if (!cur || cur.userId !== userId) return cur;
        return null; // x√≥a
      });
      await remove(child(claimsRef, userId));
    });
  </script>
</body>
</html>
