<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BOOKVE ‚Äî Read Fallback</title>
  <style>
    :root { --seat-size: 44px; --gap: 8px; --aisle: 22px;
      --bg:#0f172a; --text:#e5e7eb; --regular:#f97316; --vip:#06b6d4; --taken:#6b7280; --mine:#22c55e; --blocked:#0b1220; --badge:#0ea5e9; --screen:#e5e7eb; --pending:#facc15; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:grid;place-items:start center;min-height:100svh;padding:24px}
    .app{width:min(1150px,96vw)}
    h1{margin:0 0 6px;font-size:22px;font-weight:800}
    .sub{margin:0 0 8px;opacity:.9}
    .topbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .input{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:#111827}
    .input input{background:transparent;border:none;outline:none;color:var(--text);font-size:14px;width:220px}
    button{border:none;background:var(--badge);color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:#374151}
    .screen{text-align:center;padding:10px;margin:16px auto 12px;border-radius:10px;color:#111827;background:var(--screen);width:70%;font-weight:700;letter-spacing:.5px}
    .row{display:grid;grid-auto-flow:column;gap:var(--gap);align-items:center}
    .rowLabel{width:28px;text-align:right;opacity:.95;font-weight:800}
    .rowLabel.right{text-align:left}
    .colHeader{text-align:center;opacity:.85;font-weight:800}
    .seat{width:var(--seat-size);height:var(--seat-size);border-radius:10px;background:var(--regular);display:grid;place-items:center;font-weight:800;cursor:pointer;position:relative;user-select:none;transition:transform .05s ease;outline:2px solid transparent}
    .seat.vip{background:var(--vip)}
    .seat:hover{transform:translateY(-2px)}
    .seat.pending{outline-color:var(--pending)}
    .seat.taken{background:var(--taken)!important;cursor:not-allowed;pointer-events:none}
    .seat.mine{background:var(--mine)!important;outline-color:#16a34a;pointer-events:none}
    .seat.blocked{background:var(--blocked);cursor:default}
    .seat small{position:absolute;bottom:4px;font-size:10px;font-weight:700;opacity:.95}
    .aisle-v{width:var(--aisle)}
    .footer{margin-top:18px;opacity:.85;font-size:12px;text-align:center}
    .actions{display:flex;gap:10px}
    table{background:#0b1220;border:1px solid #1f2937;border-radius:10px;overflow:hidden}
    th,td{border:1px solid #1f2937}
    #status{margin-top:10px;opacity:.9}
    code.bad{color:#fecaca}
    code.ok{color:#86efac}
  </style>
</head>
<body>
  <div class="app">
    <h1>BOOKVE ‚Äî Ph√≤ng M∆∞a ƒê·ªè</h1>
    <p class="sub">Su·∫•t chi·∫øu: <strong>14:15</strong></p>
    <div class="topbar">
      <div class="input">
        <span>üë§ T√™n b·∫°n:</span>
        <input id="nameInput" placeholder="Nh·∫≠p t√™n ƒë·ªÉ gi·ªØ gh·∫ø‚Ä¶" />
      </div>
      <div class="actions">
        <button id="confirmBtn">X√°c nh·∫≠n</button>
        <button id="releaseBtn" class="secondary" title="B·ªè gh·∫ø c·ªßa b·∫°n">B·ªè gh·∫ø</button>
      </div>
    </div>

    <div id="status">Read status: <code id="readStatus">ƒëang kh·ªüi t·∫°o‚Ä¶</code> ‚Äî Fallback: <code id="fallbackMode">t·∫Øt</code></div>

    <div class="screen">M√ÄN H√åNH</div>
    <div id="headerRow" class="row" aria-hidden="true"></div>
    <div id="grid" class="grid" role="grid" aria-label="S∆° ƒë·ªì ch·ªó ng·ªìi"></div>

    <h2 style="margin-top:16px">Danh s√°ch ng∆∞·ªùi ƒë√£ ch·ªçn gh·∫ø</h2>
    <table id="bookingList" cellspacing="0" cellpadding="8" style="margin-top:8px; width:100%; border-collapse:collapse; text-align:center;">
      <thead><tr><th>H·ªç t√™n</th><th>Gh·∫ø</th><th>Lo·∫°i gh·∫ø</th><th>Th·ªùi gian</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="footer">Web ƒë∆∞·ª£c t·∫°o b·ªüi <strong>ƒêo√†n Minh Qu√¢n</strong></div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDSYH9yGzdtm3RjZuR7yjLhj4VH9qm-9PQ",
      authDomain: "xemphim-aed3c.firebaseapp.com",
      databaseURL: "https://xemphim-aed3c-default-rtdb.firebaseio.com",
      projectId: "xemphim-aed3c",
      storageBucket: "xemphim-aed3c.firebasestorage.app",
      messagingSenderId: "175453208138",
      appId: "1:175453208138:web:7436fe257eaafb2c6bf0b3"
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, get, child, remove } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const ROOM = "mua-do-1415";
    const USER_KEY="seat_user_id_v1", NAME_KEY="seat_user_name_v1";
    const userId = localStorage.getItem(USER_KEY) || (()=>{const id=crypto.getRandomValues(new Uint32Array(4)).join("-"); localStorage.setItem(USER_KEY,id); return id;})();
    const nameInput=document.getElementById('nameInput');
    nameInput.value = localStorage.getItem(NAME_KEY)||"";
    nameInput.addEventListener('input', ()=> localStorage.setItem(NAME_KEY, nameInput.value.trim()));
    const releaseBtn=document.getElementById('releaseBtn');
    const confirmBtn=document.getElementById('confirmBtn');
    const readStatus=document.getElementById('readStatus');
    const fallbackMode=document.getElementById('fallbackMode');

    const rows="ABCDEFGHIJ".split("");
    const cols=Array.from({length:11},(_,i)=>i+1);
    const verticalAisleAfter=9;
    const blocked=new Set(["D10","D11","E10","E11","F10","F11","G10","G11","H10","H11","J6","J7","A10","A11","B10","B11","C10","C11"]);
    const seatClass=row=> (["A","B","C"].includes(row))?"regular":"vip";

    const headerRow=document.getElementById('headerRow');
    const grid=document.getElementById('grid');
    function renderHeader(){
      headerRow.innerHTML=""; headerRow.appendChild(document.createElement("div"));
      for(const c of cols){
        if(c===verticalAisleAfter+1){const s=document.createElement("div"); s.className="aisle-v"; headerRow.appendChild(s);}
        const h=document.createElement("div"); h.className="colHeader"; h.style.width="var(--seat-size)"; h.textContent=c; headerRow.appendChild(h);
      }
      const right=document.createElement("div"); right.style.width="28px"; headerRow.appendChild(right);
    }
    const seatId=(r,c)=>`${r}${c}`;
    let pendingSeat=null;
    function renderGrid(){
      grid.innerHTML="";
      for(const r of rows){
        const rowEl=document.createElement("div"); rowEl.className="row"; rowEl.setAttribute("role","row");
        const left=document.createElement("div"); left.className="rowLabel"; left.textContent=r; rowEl.appendChild(left);
        for(const c of cols){
          if(c===verticalAisleAfter+1){const v=document.createElement("div"); v.className="aisle-v"; rowEl.appendChild(v);}
          const id=seatId(r,c);
          const el=document.createElement("div"); el.className=`seat ${seatClass(r)}`; el.dataset.id=id;
          if(blocked.has(id)){ el.classList.add('blocked'); } else { el.textContent=c; const holder=document.createElement("small"); holder.className="holder"; el.appendChild(holder); }
          rowEl.appendChild(el);
        }
        const right=document.createElement("div"); right.className="rowLabel right"; right.textContent=r; rowEl.appendChild(right);
        grid.appendChild(rowEl);
      }
    }
    renderHeader(); renderGrid();

    grid.addEventListener('click', e=>{
      const el=e.target.closest('.seat'); if(!el) return;
      if (el.classList.contains('blocked')||el.classList.contains('taken')||el.classList.contains('mine')) return;
      document.querySelectorAll('.seat').forEach(s=>s.classList.remove('pending'));
      el.classList.add('pending'); pendingSeat=el.dataset.id;
    });

    const seatsRef=ref(db, `rooms/${ROOM}/seats`);
    const claimsRef=ref(db, `rooms/${ROOM}/claims`);
    let mySeat=null; let fallbackTimer=null;

    function applySnapshot(data){
      mySeat=null;
      document.querySelectorAll('.seat').forEach(el=>{
        if(el.classList.contains('blocked')) return;
        const id=el.dataset.id, s=data[id];
        el.classList.remove('taken','mine');
        const holder=el.querySelector('.holder'); if(holder) holder.textContent="";
        if(s && s.userId){
          if(s.userId===userId){ el.classList.add('mine'); mySeat=id; }
          else { el.classList.add('taken'); }
          if(holder && s.name) holder.textContent=s.name;
        }
      });
      releaseBtn.disabled=!mySeat;
      const tbody=document.querySelector("#bookingList tbody");
      tbody.innerHTML="";
      const entries=Object.entries(data || {}).filter(([_,s])=>s&&s.userId&&s.name);
      entries.sort((a,b)=>(a[1].ts||0)-(b[1].ts||0));
      for(const [id,s] of entries){
        const tr=document.createElement("tr");
        const tdName=document.createElement("td"); tdName.textContent=s.name;
        const tdSeat=document.createElement("td"); tdSeat.textContent=id;
        const tdType=document.createElement("td"); tdType.textContent=(["A","B","C"].includes(id[0]))?"Th∆∞·ªùng":"VIP";
        const tdTime=document.createElement("td"); tdTime.textContent=new Date(s.ts||Date.now()).toLocaleString();
        tr.append(tdName,tdSeat,tdType,tdTime); tbody.appendChild(tr);
      }
    }

    function startFallback(){
      if (fallbackTimer) return;
      fallbackMode.textContent = 'b·∫≠t'; fallbackMode.className='ok';
      const url = `${firebaseConfig.databaseURL}/rooms/${ROOM}/seats.json`;
      const tick = async () => {
        try{
          const res = await fetch(url, { cache: 'no-store' });
          const json = await res.json();
          applySnapshot(json || {});
          readStatus.textContent = 'ƒëang poll (REST)';
        }catch(e){
          readStatus.textContent = 'poll l·ªói';
        }
      };
      tick();
      fallbackTimer = setInterval(tick, 2000);
    }

    try{
      onValue(seatsRef, (snap)=>{
        readStatus.textContent='ƒë√£ k·∫øt n·ªëi realtime'; readStatus.className='ok';
        const data = snap.val() || {};
        applySnapshot(data);
      }, (err)=>{
        readStatus.textContent = 'l·ªói ƒë·ªçc realtime'; readStatus.className='bad';
        startFallback();
      });
    }catch(e){
      readStatus.textContent = 'l·ªói thi·∫øt l·∫≠p realtime'; readStatus.className='bad';
      startFallback();
    }

    async function tryClaim(id){
      if(!id){ alert("H√£y ch·ªçn gh·∫ø tr∆∞·ªõc khi X√°c nh·∫≠n!"); return; }
      const el=document.querySelector(`.seat[data-id="${id}"]`);
      if(!el || el.classList.contains('blocked') || el.classList.contains('taken')) return;
      const name=nameInput.value.trim(); if(!name){ alert("Nh·∫≠p t√™n tr∆∞·ªõc khi gi·ªØ gh·∫ø nh√©!"); return; }

      const myClaimSnap = await get(child(claimsRef, userId));
      const claimed = myClaimSnap.val();
      if (claimed && claimed !== id){ alert(`B·∫°n ƒë√£ gi·ªØ gh·∫ø ${claimed}. B·∫•m 'B·ªè gh·∫ø' tr∆∞·ªõc khi ch·ªçn gh·∫ø kh√°c.`); return; }

      const seatRef=child(seatsRef, id);
      const result=await runTransaction(seatRef, (cur)=>{
        if(cur && cur.userId && cur.userId!==userId){ return cur; }
        return { userId, name, ts: Date.now() };
      });
      if(!result.committed){ alert("Gh·∫ø v·ª´a b·ªã ng∆∞·ªùi kh√°c gi·ªØ m·∫•t. H√£y ch·ªçn gh·∫ø kh√°c!"); return; }
      await set(child(claimsRef, userId), id);
      document.querySelectorAll('.seat').forEach(s=>s.classList.remove('pending'));
    }
    confirmBtn.addEventListener('click', ()=>tryClaim(pendingSeat));

    releaseBtn.addEventListener('click', async ()=>{
      if(!mySeat) return;
      const seatPath=child(seatsRef, mySeat);
      await runTransaction(seatPath, (cur)=>{ if(!cur || cur.userId!==userId) return cur; return null; });
      await remove(child(claimsRef, userId));
    });
  </script>
</body>
</html>
